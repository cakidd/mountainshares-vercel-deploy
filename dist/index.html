<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Commons -- West Virginia Business Network | MountainShares</title>
    <meta name="description" content="The future of local commerce. Innovative business networking platform for West Virginia communities.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cakidd.github.io/Commons-Connect/">
    <meta property="og:title" content="The Commons - West Virginia Business Network">
    <meta property="og:description" content="Local digital currency, free business analytics, and community marketplace. Launching Fall 2025 in Fayette County, WV.">
    <meta property="og:image" content="https://i.imgur.com/cLHJYe3.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://cakidd.github.io/Commons-Connect/">
    <meta property="twitter:title" content="The Commons - West Virginia Business Network">
    <meta property="twitter:description" content="Local digital currency, free business analytics, and community marketplace. Launching Fall 2025 in Fayette County, WV.">
    <meta property="twitter:image" content="https://i.imgur.com/cLHJYe3.jpg">
    
    <!-- FORCE CACHE REFRESH -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèîÔ∏è</text></svg>">
    
    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-526FNHHQ5Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-526FNHHQ5Y');
    </script>

    <style>
        /* ADVANCED DIGITAL DESIGN SYSTEM */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --wv-gold: #FFD700;
            --mountain-blue: #0066FF;
            --sky-blue: #00BFFF;
            --deep-black: #000000;
            --mountain-dark: #0A0A0A;
            --stone-gray: #1A1A1A;
            --mountain-white: #FFFFFF;
            --mountain-gradient: linear-gradient(45deg, #000000, #001122, #0066FF);
            --gold-gradient: linear-gradient(135deg, #FFD700, #FFA500, #FF6B35);
            --premium-gradient: conic-gradient(from 0deg, #FFD700, #0066FF, #FFD700);
        }

        body {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            background: var(--mountain-dark);
            color: var(--mountain-white);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* DYNAMIC BACKGROUND EFFECTS */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 70%, rgba(0, 191, 255, 0.05) 0%, transparent 50%);
            animation: dynamicPulse 8s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes dynamicPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .business-app {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            min-height: 100vh;
            position: relative;
            border-left: 3px solid var(--wv-gold);
            border-right: 3px solid var(--mountain-blue);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .business-header {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 26, 26, 0.8));
            backdrop-filter: blur(20px);
            border-bottom: 3px solid transparent;
            border-image: var(--premium-gradient) 1;
            padding: 32px 40px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .premium-logo {
            width: 80px;
            height: 80px;
            background: conic-gradient(from 0deg, #FFD700, #0066FF, #FFD700);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            animation: logoSpin 6s linear infinite;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .premium-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: logoScan 3s linear infinite;
        }

        @keyframes logoSpin {
            0% { transform: rotateY(0deg) rotateX(0deg); }
            100% { transform: rotateY(360deg) rotateX(360deg); }
        }

        @keyframes logoScan {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .brand-section h1 {
            font-family: 'Orbitron', monospace;
            font-size: 48px;
            font-weight: 900;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            animation: textGlow 4s ease-in-out infinite;
        }

        @keyframes textGlow {
            0%, 100% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.3) saturate(1.5); }
        }

        .business-tagline {
            color: var(--sky-blue);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: taglinePulse 2s ease-in-out infinite;
        }

        @keyframes taglinePulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .connect-btn {
            background: var(--gold-gradient);
            color: var(--mountain-dark);
            border: none;
            padding: 16px 32px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
        }

        .connect-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.6);
        }

        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 14px;
            color: var(--sky-blue);
            border: 2px solid var(--sky-blue);
        }

        .business-nav {
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.9), rgba(26, 26, 26, 0.95));
            backdrop-filter: blur(30px);
            border-bottom: 2px solid var(--sky-blue);
            padding: 0 40px;
            position: sticky;
            top: 145px;
            z-index: 900;
        }

        .nav-container {
            display: flex;
            gap: 4px;
            max-width: 1600px;
            margin: 0 auto;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-item {
            flex-shrink: 0;
            padding: 24px 36px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border-bottom: 4px solid transparent;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Orbitron', monospace;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--gold-gradient);
            transition: all 0.4s ease;
            transform: translateX(-50%);
        }

        .nav-item:hover {
            color: var(--wv-gold);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .nav-item:hover::before {
            width: 90%;
        }

        .nav-item.active {
            color: var(--wv-gold);
            border-bottom-color: var(--wv-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 102, 255, 0.1));
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
        }

        .nav-item.active::before {
            width: 100%;
        }

        .main-content {
            padding: 64px 40px;
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        .content-tab {
            display: none;
        }

        .content-tab.active {
            display: block;
            animation: slideIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95) rotateX(10deg);
                filter: blur(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
                filter: blur(0px);
            }
        }

        .hero-section {
            background: var(--mountain-gradient);
            padding: 120px 80px;
            border-radius: 30px;
            margin-bottom: 80px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.6), 0 20px 60px rgba(0, 102, 255, 0.3);
            transform-style: preserve-3d;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent, rgba(0, 102, 255, 0.1), transparent);
            animation: heroSpin 15s linear infinite;
        }

        @keyframes heroSpin {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(360deg) scale(1.1); }
        }

        .hero-content {
            position: relative;
            z-index: 3;
        }

        .hero-section h2 {
            font-family: 'Orbitron', monospace;
            font-size: 64px;
            font-weight: 900;
            margin-bottom: 32px;
            line-height: 1.1;
            color: var(--mountain-white);
            text-shadow: 0 0 50px rgba(255, 215, 0, 0.6);
            animation: heroTextFloat 6s ease-in-out infinite;
        }

        @keyframes heroTextFloat {
            0%, 100% { transform: translateY(0) rotateX(0deg); }
            50% { transform: translateY(-10px) rotateX(5deg); }
        }

        .hero-section p {
            font-size: 24px;
            margin-bottom: 56px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            opacity: 0.95;
            line-height: 1.7;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .button-group {
            display: flex;
            gap: 32px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-premium {
            padding: 24px 48px;
            border: 3px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 800;
            font-size: 18px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            min-width: 250px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Orbitron', monospace;
        }

        .btn-premium:hover {
            transform: translateY(-6px) scale(1.05) rotateX(10deg);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.6), 0 20px 60px rgba(0, 102, 255, 0.3);
        }

        .btn-primary {
            background: var(--gold-gradient);
            color: var(--mountain-dark);
            border-color: var(--wv-gold);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(0, 102, 255, 0.2));
            color: var(--mountain-white);
            border-color: var(--sky-blue);
            backdrop-filter: blur(20px);
        }

        .btn-secondary:hover {
            background: var(--sky-blue);
            color: var(--mountain-dark);
        }

        .coming-soon-banner {
            background: var(--gold-gradient);
            color: var(--mountain-dark);
            padding: 12px 32px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: inline-block;
            margin-bottom: 32px;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
            border: 2px solid var(--wv-gold);
            animation: comingSoonPulse 2s ease-in-out infinite;
        }

        @keyframes comingSoonPulse {
            0%, 100% { transform: scale(1) rotateZ(0deg); }
            50% { transform: scale(1.05) rotateZ(1deg); }
        }

        /* MOUNTAINSHARES SPECIFIC STYLES */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        .card h2, .card h3 {
            color: var(--wv-gold);
            margin-bottom: 24px;
            font-family: 'Orbitron', monospace;
        }

        .purchase-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--sky-blue);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--sky-blue);
            border-radius: 12px;
            font-size: 16px;
            background: var(--mountain-dark);
            color: var(--mountain-white);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--wv-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .amount-display {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            padding: 24px;
            border: 2px solid var(--wv-gold);
        }

        .amount-breakdown {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 16px;
        }

        .total-amount {
            font-size: 20px;
            font-weight: bold;
            color: var(--wv-gold);
            border-top: 2px solid var(--wv-gold);
            padding-top: 16px;
            margin-top: 16px;
        }

        .purchase-btn {
            background: var(--gold-gradient);
            color: var(--mountain-dark);
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .purchase-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        .purchase-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .balance-card {
            background: var(--mountain-gradient);
            color: white;
            padding: 24px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--sky-blue);
        }

        .balance-amount {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 102, 255, 0.1));
            border-radius: 15px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .verified {
            background: #28a745;
            color: white;
        }

        .unverified {
            background: #dc3545;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--sky-blue);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--wv-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #dc3545;
            padding: 16px;
            border-radius: 10px;
            margin: 16px 0;
        }

        .success {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            color: #28a745;
            padding: 16px;
            border-radius: 10px;
            margin: 16px 0;
        }

        .info {
            background: rgba(0, 191, 255, 0.1);
            border: 2px solid var(--sky-blue);
            color: var(--sky-blue);
            padding: 16px;
            border-radius: 10px;
            margin: 16px 0;
        }

        /* GRID LAYOUTS */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
            margin: 40px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 32px;
            border-radius: 15px;
            border: 2px solid var(--sky-blue);
            text-align: center;
        }

        .feature-card h4 {
            color: var(--wv-gold);
            font-size: 24px;
            margin-bottom: 16px;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .business-header, .business-nav, .main-content {
                padding-left: 20px;
                padding-right: 20px;
            }

            .hero-section {
                padding: 80px 40px;
            }

            .hero-section h2 {
                font-size: 42px;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .btn-premium {
                width: 100%;
                max-width: 350px;
            }

            .purchase-grid, .balance-grid {
                grid-template-columns: 1fr;
            }

            .nav-container {
                overflow-x: auto;
                padding-bottom: 10px;
            }
        }
    </style>

<script src="https://js.stripe.com/v3"></script>
</head>

<body>
    <div class="business-app">
        <header class="business-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="premium-logo">üèîÔ∏è</div>
                    <div class="brand-section">
                        <h1>The Commons</h1>
                        <div class="business-tagline">Digital Business Network</div>
                    </div>
                </div>
                <div class="wallet-section">
                    <div id="walletInfo" class="wallet-info" style="display: none;"></div>
                    <button id="connectWallet" class="connect-btn">Connect Wallet</button>
                </div>
            </div>
        </header>

        <div class="business-nav">
            <nav class="nav-container" role="tablist">
                <button class="nav-item active" onclick="showTab('home')" role="tab">üèîÔ∏è Home</button>
                <button class="nav-item" onclick="showTab('business')" role="tab">üè¢ Business</button>
                <button class="nav-item" onclick="showTab('feed')" role="tab">üåê Business Feed</button>
                <button class="nav-item" onclick="showTab('mountainshares')" role="tab">üíé MountainShares</button>
                <button class="nav-item" onclick="showTab('access')" role="tab">üöÄ Business Access</button>
            </nav>
        </div>

        <main class="main-content">
            <!-- HOME TAB -->
            <div id="home" class="content-tab active" role="tabpanel">
                <div class="hero-section">
                    <div class="hero-content">
                        <h2>West Virginia's Digital Business Revolution</h2>
                        <p>Keep money in our communities with MountainShares rewards, professional business tools, and a trusted local marketplace. Free for all businesses and residents.</p>
                        <div class="button-group">
                            <button class="btn-premium btn-primary" onclick="showTab('access')">üéØ Join The Network</button>
                            <button class="btn-premium btn-secondary" onclick="showTab('mountainshares')">üíé Learn About MountainShares</button>
                        </div>
                    </div>
                </div>

                <!-- What Is The Commons Section -->
                <div style="padding: 80px 40px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(42, 42, 42, 0.6)); border-radius: 20px; margin-bottom: 60px;">
                    <h3 style="font-size: 42px; font-family: 'Orbitron', monospace; color: var(--wv-gold); margin-bottom: 32px; text-align: center;">üèîÔ∏è What Is The Commons?</h3>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4>üíé Local Currency System</h4>
                            <p style="color: var(--mountain-white); line-height: 1.6;">Earn MountainShares (1 MS = $1) as bonuses for good work and community participation. Keep money circulating locally instead of flowing to big corporations.</p>
                        </div>
                        <div class="feature-card">
                            <h4>üè¢ Business Directory</h4>
                            <p style="color: var(--mountain-white); line-height: 1.6;">Free professional listings with $15,000+ worth of business analytics. Customer tracking, competitor analysis, and sales metrics normally only big companies can afford.</p>
                        </div>
                        <div class="feature-card">
                            <h4>‚öñÔ∏è Community Protection</h4>
                            <p style="color: var(--mountain-white); line-height: 1.6;">Democratic governance system where the community votes out bad actors. Real financial consequences for scams, no-shows, and rude behavior.</p>
                        </div>
                    </div>
                </div>

                <!-- Coming Soon Banner -->
                <div style="text-align: center;">
                    <div class="coming-soon-banner">‚ö° LAUNCHING FALL 2025 IN FAYETTE COUNTY ‚ö°</div>
                </div>
            </div>

            <!-- BUSINESS TAB -->
            <div id="business" class="content-tab" role="tabpanel">
                <div style="text-align: center; padding: 60px 40px 40px 40px;">
                    <h2 style="font-size: 48px; font-family: 'Orbitron', monospace; color: var(--wv-gold); margin-bottom: 24px;">üè¢ Business Directory & Tools</h2>
                    <p style="font-size: 24px; color: var(--sky-blue); margin-bottom: 50px; max-width: 800px; margin-left: auto; margin-right: auto;">Everything your business needs to succeed - completely free. Professional tools that normally cost thousands.</p>
                </div>
                <div style="text-align: center; margin-top: 50px;">
                    <div class="coming-soon-banner">Business Directory Launching Fall 2025</div>
                </div>
            </div>

            <!-- FEED TAB -->
            <div id="feed" class="content-tab" role="tabpanel">
                <div style="text-align: center; padding: 60px 40px 40px 40px;">
                    <h2 style="font-size: 48px; font-family: 'Orbitron', monospace; color: var(--wv-gold); margin-bottom: 24px;">üåê Community Feed & Marketplace</h2>
                    <p style="font-size: 24px; color: var(--sky-blue); margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">Local social network where neighbors buy, sell, and connect. Like Facebook, but only for your community.</p>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <div class="coming-soon-banner">Community Feed Launching Phase 2 - Winter 2025</div>
                </div>
            </div>

            <!-- MOUNTAINSHARES TAB -->
            <div id="mountainshares" class="content-tab" role="tabpanel">
                <div style="text-align: center; padding: 60px 40px 40px 40px;">
                    <h2 style="font-size: 48px; font-family: 'Orbitron', monospace; color: var(--wv-gold); margin-bottom: 24px;">üíé MountainShares Currency</h2>
                    <p style="font-size: 24px; color: var(--sky-blue); margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">Local digital currency that keeps money in West Virginia communities. <strong>1 MountainShare = $1 USD</strong></p>
                </div>

                <!-- Purchase Section -->
                <div class="card">
                    <h2>Purchase MountainShares</h2>
                    <div class="purchase-grid">
                        <div>
                            <div class="form-group">
                                <label for="purchaseAmount">Amount (USD)</label>
                                <input type="number" id="purchaseAmount" min="1" max="10000" value="10" step="1">
                            </div>
                            <button id="purchaseBtn" class="purchase-btn">Connect Wallet to Purchase</button>
                            <div id="txStatus" style="display: none;"></div>
                        </div>
                        <div class="amount-display">
                            <h3>Payment Breakdown</h3>
                            <div class="amount-breakdown">
                                <span>MountainShares:</span>
                                <span id="baseAmount">$10.00</span>
                            </div>
                            <div class="amount-breakdown">
                                <span>Loading Fee (2%):</span>
                                <span id="feeAmount">$0.20</span>
                            </div>
                            <div class="amount-breakdown">
                                <span>Subtotal:</span>
                                <span id="subtotal">$10.20</span>
                            </div>
                            <div class="amount-breakdown">
                                <span>Stripe Fee:</span>
                                <span id="stripeFee">$0.60</span>
                            </div>
                            <div class="total-amount">
                                <div class="amount-breakdown">
                                    <span>Total:</span>
                                    <span id="totalAmount">$10.80</span>
                                </div>
                            </div>
                            <div id="tokenDelivery" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--wv-gold);">
                                <div style="font-size: 14px; color: var(--sky-blue); margin-bottom: 8px;">
                                    <strong>üèîÔ∏è Tokens will be sent to:</strong>
                                </div>
                                <div id="deliveryAddress" style="font-family: monospace; font-size: 12px; background: rgba(255, 255, 255, 0.1); padding: 8px; border-radius: 5px; word-break: break-all;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Balance and Status Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <!-- Balance Section -->
                    <div class="card">
                        <h2>Your Balances</h2>
                        <div id="loadingBalances" class="loading">
                            <div class="spinner"></div>
                            <p>Loading balances...</p>
                        </div>
                        <div id="balanceContent" style="display: none;">
                            <div class="balance-grid">
                                <div class="balance-card">
                                    <div class="balance-amount" id="pmsBalance">0.00</div>
                                    <div class="balance-label">PMS Tokens</div>
                                </div>
                                <div class="balance-card">
                                    <div class="balance-amount" id="emsBalance">0.00</div>
                                    <div class="balance-label">EMS Tokens</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Section -->
                    <div class="card">
                        <h2>Account Status</h2>
                        <div class="status-section">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                <span>KYC Status:</span>
                                <span id="kycBadge" class="status-badge unverified">Unverified</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                <span>Daily Limit:</span>
                                <span id="dailyLimit">$500</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Available Today:</span>
                                <span id="dailyAvailable">$500</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 40px;">
                    <div class="coming-soon-banner">MountainShares Phase 1 Launching Fall 2025</div>
                </div>
            </div>

            <!-- ACCESS TAB -->
            <div id="access" class="content-tab" role="tabpanel">
                <div style="text-align: center; padding: 60px 40px 40px 40px;">
                    <h2 style="font-size: 48px; font-family: 'Orbitron', monospace; color: var(--wv-gold); margin-bottom: 24px;">üöÄ Join The Commons Network</h2>
                    <p style="font-size: 24px; color: var(--sky-blue); margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">Be part of West Virginia's economic revolution. <strong>Completely free</strong> for all businesses and residents.</p>
                </div>

                <!-- Join Now Section -->
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 102, 255, 0.1)); padding: 50px 40px; border-radius: 20px; text-align: center; margin-bottom: 40px;">
                    <h3 style="color: var(--wv-gold); font-size: 32px; margin-bottom: 24px;">üéØ Ready to Join?</h3>
                    <div style="max-width: 600px; margin: 0 auto;">
                        <p style="color: var(--mountain-white); font-size: 18px; line-height: 1.6; margin-bottom: 32px;">
                            Get on the waitlist to be among the first businesses and residents in Fayette County to experience The Commons. <strong style="color: var(--sky-blue);">No cost, no risk, huge potential.</strong>
                        </p>
                        <form id="waitlist-form" style="max-width: 500px; margin: 0 auto;">
                            <input type="email" id="email-input" placeholder="Enter your email address" required style="width: 100%; padding: 20px; border: 3px solid var(--sky-blue); border-radius: 15px; font-size: 18px; background: var(--mountain-dark); color: var(--mountain-white); margin-bottom: 20px;">
                            <input type="text" id="business-input" placeholder="Business name (optional)" style="width: 100%; padding: 20px; border: 3px solid var(--sky-blue); border-radius: 15px; font-size: 18px; background: var(--mountain-dark); color: var(--mountain-white); margin-bottom: 20px;">
                            <button type="submit" class="btn-premium btn-primary" style="width: 100%; justify-content: center; font-size: 20px;">‚ö° Join The Waitlist</button>
                        </form>
                        <div id="waitlist-status" style="margin-top: 20px; padding: 15px; border-radius: 10px; display: none;">
                            <p id="waitlist-message" style="margin: 0; text-align: center; font-weight: bold;"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        console.log('üèîÔ∏è THE COMMONS BUSINESS NETWORK LOADING üèîÔ∏è');

        // BACKEND CONFIGURATION
        const MOUNTAINSHARES_BACKEND_URL = 'https://mountainshares-backend-production.up.railway.app';
        
        // CONTRACT CONFIGURATION
        const CONFIG = {
            ARBITRUM_CHAIN_ID: 42161,
            CONTRACT_ADDRESS: '0xF8c137EF2edB631Fc3f86EC783Ecc113e56e57B3',
            VIEW_CONTRACT: '0xd42614854b00BcBE73C930193CEAc2a26c9e929E',
            RPC_URL: 'https://arb1.arbitrum.io/rpc'
        };

        // CONTRACT ABI
        const CONTRACT_ABI = [
            "function purchaseShares() external payable",
            "function purchasedMSBalances(address) view returns (uint256)",
            "function earnedMSBalances(address) view returns (uint256)",
            "function kycStatus(address) view returns (bool,uint256)",
            "function dailySpentUSD(address) view returns (uint256)",
            "function getSystemStats() view returns (uint256,uint256,uint256,bool,bool,bool)"
        ];

        // GLOBAL VARIABLES
        let web3Provider;
        let web3Signer;
        let msContract;
        let currentUserAddress;

        // TAB NAVIGATION SYSTEM
        function showTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            const contents = document.querySelectorAll('.content-tab');
            contents.forEach(content => content.classList.remove('active'));

            // Remove active from nav
            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Activate nav item
            const tabNames = ['home', 'business', 'feed', 'mountainshares', 'access'];
            const tabIndex = tabNames.indexOf(tabName);
            if (tabIndex >= 0) {
                const navTabs = document.querySelectorAll('.nav-item');
                if (navTabs[tabIndex]) {
                    navTabs[tabIndex].classList.add('active');
                }
            }

            // Load wallet data if on MountainShares tab and wallet connected
            if (tabName === 'mountainshares' && currentUserAddress) {
                loadUserAccountData();
            }
        }

        // WALLET CONNECTION SYSTEM
        async function handleWalletConnection() {
            if (typeof window.ethereum === 'undefined') {
                showMessage('MetaMask not detected. Please install MetaMask to continue.', 'error');
                return;
            }

            try {
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('connectWallet').textContent = 'Connecting...';

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await switchToArbitrumNetwork();
                await connectToWallet();
                
            } catch (error) {
                console.error('Wallet connection failed:', error);
                showMessage('Failed to connect wallet: ' + error.message, 'error');
                resetWalletUI();
            }
        }

        async function switchToArbitrumNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${CONFIG.ARBITRUM_CHAIN_ID.toString(16)}` }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: `0x${CONFIG.ARBITRUM_CHAIN_ID.toString(16)}`,
                            chainName: 'Arbitrum One',
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                            rpcUrls: [CONFIG.RPC_URL],
                            blockExplorerUrls: ['https://arbiscan.io/']
            }
        }
                        }]
                    });
                } else {
                    throw switchError;
                }
            }
        }

        async function connectToWallet() {
            web3Provider = new ethers.BrowserProvider(window.ethereum);
            web3Signer = await web3Provider.getSigner();
            currentUserAddress = await web3Signer.getAddress();
            
            msContract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, CONTRACT_ABI, web3Signer);
            
            // Update UI
            document.getElementById('walletInfo').textContent = `${currentUserAddress.slice(0, 6)}...${currentUserAddress.slice(-4)}`;
            document.getElementById('walletInfo').style.display = 'block';
            document.getElementById('connectWallet').textContent = 'Connected ‚úÖ';
            document.getElementById('connectWallet').style.background = '#28a745';
            
            document.getElementById('purchaseBtn').disabled = false;
            document.getElementById('purchaseBtn').textContent = 'Purchase with Stripe';
            
            // Show token delivery address
            document.getElementById('deliveryAddress').textContent = currentUserAddress;
            document.getElementById('tokenDelivery').style.display = 'block';
            
            console.log('Wallet connected:', currentUserAddress);
        }

        async function checkExistingConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                        if (parseInt(chainId, 16) === CONFIG.ARBITRUM_CHAIN_ID) {
                            await connectToWallet();
                        }
                    }
                } catch (error) {
                    console.log('No existing connection found');
                }
            }
        }

        // MOUNTAINSHARES PURCHASE SYSTEM
        function calculateFees() {
            const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            
            // 2% loading fee
            const loadingFee = amount * 0.02;
            const subtotal = amount + loadingFee;
            
            // Stripe processing fee (2.9% + $0.30)
            const stripeFee = (subtotal * 0.029) + 0.30;
            const total = subtotal + stripeFee;
            
            // Update display
            document.getElementById('baseAmount').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('feeAmount').textContent = `$${loadingFee.toFixed(2)}`;
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('stripeFee').textContent = `$${stripeFee.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
        }

        async function handlePurchaseClick() {
            if (!currentUserAddress) {
                showMessage('Please connect your wallet first to specify where tokens should be sent.', 'error');
                await handleWalletConnection();
                return;
            }

            const amount = parseFloat(document.getElementById('purchaseAmount').value);
            
            if (!amount || amount < 1) {
                showMessage('Please enter a valid amount (minimum $1)', 'error');
                return;
            }
            
            if (amount > 10000) {
                showMessage('Maximum purchase amount is $10,000', 'error');
                return;
            }
            
            try {
                document.getElementById('purchaseBtn').disabled = true;
                document.getElementById('purchaseBtn').textContent = 'Creating Checkout...';
                
                showMessage('Preparing Stripe checkout...', 'info');
                
                const checkoutData = {
                    amount: amount,
                    walletAddress: currentUserAddress,
                    currency: 'usd',
                    successUrl: window.location.origin + '/success',
                    cancelUrl: window.location.href
                };
                
                console.log('Creating checkout session:', checkoutData);
                console.log("Amount:", amount);
                console.log("Wallet:", currentUserAddress);
                console.log("CheckoutData object:", JSON.stringify(checkoutData));
                
                const response = await fetch(`/api/create-checkout-session`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(checkoutData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const session = await response.json();
                
                if (session.error) {
                    throw new Error(session.error);
                }
                
                showMessage('Redirecting to Stripe checkout...', 'info');
                
                if (session.url) {
                    window.location.href = session.url;
                } else {
                    throw new Error('No checkout URL provided by server');
                }
                
            } catch (error) {
                console.error('Stripe checkout failed:', error);
                
                let errorMessage = 'Checkout failed: ';
                if (error.message.includes('404')) {
                    errorMessage += 'Payment endpoint not found. Please contact support.';
                } else if (error.message.includes('500')) {
                    errorMessage += 'Server error. Please try again.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'Cannot connect to payment server. Please check your connection.';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                document.getElementById('purchaseBtn').disabled = false;
                document.getElementById('purchaseBtn').textContent = 'Purchase with Stripe';
            }
        }

        async function loadUserAccountData() {
            try {
                document.getElementById('loadingBalances').style.display = 'block';
                document.getElementById('balanceContent').style.display = 'none';
                
                // Load token balances
                const [pmsBalance, emsBalance] = await Promise.all([
                    msContract.purchasedMSBalances(currentUserAddress),
                    msContract.earnedMSBalances(currentUserAddress)
                ]);
                
                document.getElementById('pmsBalance').textContent = ethers.formatEther(pmsBalance);
                document.getElementById('emsBalance').textContent = ethers.formatEther(emsBalance);
                
                // Load KYC information
                try {
                    const [isVerified, kycLevel] = await msContract.kycStatus(currentUserAddress);
                    const kycBadge = document.getElementById('kycBadge');
                    
                    if (isVerified) {
                        kycBadge.textContent = `Verified (Level ${kycLevel})`;
                        kycBadge.className = 'status-badge verified';
                    } else {
                        kycBadge.textContent = 'Unverified';
                        kycBadge.className = 'status-badge unverified';
                    }
                    
                    // Set daily limits based on KYC level
                    const limits = [500, 2500, 10000, 50000];
                    const dailyLimit = isVerified ? limits[Number(kycLevel)] || 500 : 500;
                    
                    const dailySpent = await msContract.dailySpentUSD(currentUserAddress);
                    const remaining = dailyLimit - Number(ethers.formatEther(dailySpent));
                    
                    document.getElementById('dailyLimit').textContent = `$${dailyLimit}`;
                    document.getElementById('dailyAvailable').textContent = `$${Math.max(0, remaining)}`;
                    
                } catch (error) {
                    console.log('KYC data not available:', error.message);
                }
                
                document.getElementById('loadingBalances').style.display = 'none';
                document.getElementById('balanceContent').style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load user data:', error);
                showMessage('Failed to load account data: ' + error.message, 'error');
            }
        }

        // UTILITY FUNCTIONS
        function showMessage(message, type) {
            const statusEl = document.getElementById('txStatus');
            statusEl.className = type;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        function resetWalletUI() {
            document.getElementById('connectWallet').disabled = false;
            document.getElementById('connectWallet').textContent = 'Connect Wallet';
            document.getElementById('connectWallet').style.background = '';
            document.getElementById('purchaseBtn').disabled = false;
            document.getElementById('purchaseBtn').textContent = 'Connect Wallet to Purchase';
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('tokenDelivery').style.display = 'none';
        }

        // WAITLIST FORM HANDLING
        function handleWaitlistSubmission(e) {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const business = document.getElementById('business-input').value;

            if (!email) {
                showWaitlistMessage('‚ö†Ô∏è Please enter a valid email address', 'error');
                return;
            }

            // Simulate form submission (replace with actual endpoint)
            showWaitlistMessage('‚úÖ Thank you! You\'ve been added to the waitlist. We\'ll notify you when The Commons launches in Fall 2025!', 'success');
            
            // Reset form
            document.getElementById('waitlist-form').reset();
        }

        function showWaitlistMessage(message, type) {
            const statusDiv = document.getElementById('waitlist-status');
            const messageP = document.getElementById('waitlist-message');
            
            if (!statusDiv || !messageP) return;

            messageP.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                statusDiv.style.background = 'rgba(40, 167, 69, 0.1)';
                statusDiv.style.border = '2px solid #28a745';
                messageP.style.color = '#28a745';
            } else if (type === 'error') {
                statusDiv.style.background = 'rgba(220, 53, 69, 0.1)';
                statusDiv.style.border = '2px solid #dc3545';
                messageP.style.color = '#dc3545';
            }
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ THE COMMONS BUSINESS NETWORK LOADED üöÄ');
            console.log('üèîÔ∏è West Virginia Digital Business Revolution');
            console.log('Backend URL:', MOUNTAINSHARES_BACKEND_URL);
            
            // Set up event listeners
            document.getElementById('connectWallet').addEventListener('click', handleWalletConnection);
            document.getElementById('purchaseBtn').addEventListener('click', handlePurchaseClick);
            document.getElementById('purchaseAmount').addEventListener('input', calculateFees);
            
            // Waitlist form
            const waitlistForm = document.getElementById('waitlist-form');
            if (waitlistForm) {
                waitlistForm.addEventListener('submit', handleWaitlistSubmission);
            }
            
            // Initialize fee display
            calculateFees();
            
            // Check for existing wallet connection
            checkExistingConnection();
            
            console.log('üíé MountainShares integration ready');
        });

        // Handle account/network changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', () => {
                window.location.reload();
            });
            
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }

        console.log('üèîÔ∏è THE COMMONS - MOUNTAINSHARES WEBSITE READY üèîÔ∏è');
    </script>
<script src="force-proxy-mode.js"></script>
</body>
</html>
<script>
// WSL CORS Proxy Activation Patch
document.addEventListener('DOMContentLoaded', function() {
  window.useProxyMode = true;
  console.log('üîÑ CORS proxy mode activated via WSL');
  
  // Override fetch for MountainShares API calls
  const originalFetch = window.fetch;
  window.fetch = function(url, options) {
    if (url.includes('mountainshares-backend-production.up.railway.app')) {
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + url;
      console.log('üîÑ Proxying request:', proxyUrl);
      return originalFetch(proxyUrl, options);
    }
    return originalFetch(url, options);
  };
});
</script>
<!-- NEW SOLUTION: HTML Form Submission (No CORS Issues) -->
<script>
// Replace the JavaScript fetch with HTML form submission
function createPaymentForm() {
  const quantity = parseInt(document.getElementById('ms-quantity').value) || 1;
  const walletAddress = document.getElementById('wallet-address').value || window.selectedAccount;
  
  if (!quantity || quantity < 1) {
    console.log('‚ùå Invalid quantity');
    return;
  }
  
  if (!walletAddress || !walletAddress.startsWith('0x')) {
    console.log('‚ùå Invalid wallet address');
    return;
  }
  
  // CREATE DYNAMIC HTML FORM (Stack Overflow #68630525 solution)
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = 'https://mountainshares-backend-production.up.railway.app/api/create-checkout-session';
  
  // Add form fields
  const quantityInput = document.createElement('input');
  quantityInput.type = 'hidden';
  quantityInput.name = 'quantity';
  quantityInput.value = quantity;
  form.appendChild(quantityInput);
  
  const walletInput = document.createElement('input');
  walletInput.type = 'hidden';
  walletInput.name = 'walletAddress';
  walletInput.value = walletAddress;
  form.appendChild(walletInput);
  
  const amountInput = document.createElement('input');
  amountInput.type = 'hidden';
  amountInput.name = 'amount';
  amountInput.value = quantity;
  form.appendChild(amountInput);
  
  const productInput = document.createElement('input');
  productInput.type = 'hidden';
  productInput.name = 'productName';
  productInput.value = 'MountainShares Token';
  form.appendChild(productInput);
  
  // Submit form (NO CORS ISSUES - YouTube tutorial solution)
  document.body.appendChild(form);
  form.submit();
  
  console.log('‚úÖ Form submitted - no CORS issues!');
}

// Override the purchase function to use form submission
window.handlePurchaseClick = function() {
  createPaymentForm();
};

console.log('‚úÖ HTML form submission payment system activated');
</script>
<script>
// Use MetaMask's official Stripe integration (from search results)
async function purchaseWithMetaMaskStripe() {
  const quantity = parseInt(document.getElementById('ms-quantity').value) || 1;
  const walletAddress = document.getElementById('wallet-address').value;
  
  if (!walletAddress || !walletAddress.startsWith('0x')) {
    showStatus('Please connect MetaMask first', 'error', 'payment-status');
    return;
  }
  
  try {
    // Calculate the USD amount needed
    const usdAmount = quantity * 1.35; // 1 MS = $1.35 including fees
    
    // Use MetaMask's official on-ramp with Stripe (from search results)
    const portfolioUrl = `https://portfolio.metamask.io/buy?amount=${usdAmount}&currency=USD`;
    
    // Open MetaMask Portfolio (includes Stripe integration)
    const popup = window.open(portfolioUrl, 'metamask-stripe', 'width=400,height=600,scrollbars=yes');
    
    showStatus(`Opening MetaMask Portfolio to purchase $${usdAmount} worth of crypto. After purchase, you can convert to MountainShares.`, 'success', 'payment-status');
    
    console.log('‚úÖ Using official MetaMask-Stripe integration');
    
  } catch (error) {
    console.error('‚ùå Failed to open MetaMask Portfolio:', error);
    showStatus('Failed to open MetaMask Portfolio. Please try again.', 'error', 'payment-status');
  }
}

// Update your purchase button to use the official integration
window.initiatePurchase = purchaseWithMetaMaskStripe;

console.log('‚úÖ MetaMask-Stripe official integration loaded');
</script>
<script>
// Fix MetaMask persistent connection issue (Ethereum Stack Exchange #165686 solution)
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üîç Checking MetaMask persistent connection state...');
  
  if (typeof window.ethereum !== 'undefined') {
    try {
      // Check actual MetaMask connection state (not just website state)
      const accounts = await window.ethereum.request({ 
        method: 'eth_accounts' 
      });
      
      if (accounts.length > 0) {
        // MetaMask is persistently connected
        console.log('‚úÖ MetaMask persistently connected:', accounts[0]);
        
        // Update UI to match actual MetaMask state
        document.getElementById('wallet-address').value = accounts[0];
        window.selectedAccount = accounts[0];
        
        // Force disconnect and reconnect to clear state conflicts
        try {
          // Request fresh connection to clear any state conflicts
          const freshAccounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
          });
          
          console.log('üîÑ MetaMask connection refreshed:', freshAccounts[0]);
          showStatus('MetaMask connection refreshed!', 'success', 'payment-status');
          
        } catch (error) {
          console.log('‚ö†Ô∏è MetaMask connection refresh failed:', error);
        }
      }
      
      // Listen for account changes to handle persistent connection issues
      window.ethereum.on('accountsChanged', function(accounts) {
        if (accounts.length === 0) {
          console.log('üîå MetaMask actually disconnected');
          document.getElementById('wallet-address').value = '';
          window.selectedAccount = null;
          
          // Clear any persistent connection conflicts
          localStorage.removeItem('metamask_connected');
          
        } else {
          console.log('üîÑ MetaMask account changed (persistent):', accounts[0]);
          document.getElementById('wallet-address').value = accounts[0];
          window.selectedAccount = accounts[0];
          
          // Store persistent connection state
          localStorage.setItem('metamask_connected', 'true');
          localStorage.setItem('metamask_account', accounts[0]);
        }
      });
      
    } catch (error) {
      console.log('‚ùå Error checking MetaMask persistent state:', error);
    }
  }
});

// Override connectWallet to handle persistent connections
window.connectWallet = async function() {
  if (typeof window.ethereum !== 'undefined') {
    try {
      // Check if already persistently connected
      const existingAccounts = await window.ethereum.request({ 
        method: 'eth_accounts' 
      });
      
      if (existingAccounts.length > 0) {
        // Already connected, just update UI
        document.getElementById('wallet-address').value = existingAccounts[0];
        window.selectedAccount = existingAccounts[0];
        showStatus('MetaMask already connected (persistent)!', 'success', 'payment-status');
        console.log('‚úÖ Using persistent MetaMask connection:', existingAccounts[0]);
        return;
      }
      
      // Not connected, request new connection
      const accounts = await window.ethereum.request({ 
        method: 'eth_requestAccounts' 
      });
      
      document.getElementById('wallet-address').value = accounts[0];
      window.selectedAccount = accounts[0];
      showStatus('MetaMask connected successfully!', 'success', 'payment-status');
      console.log('‚úÖ New MetaMask connection established:', accounts[0]);
      
    } catch (error) {
      console.error('‚ùå Failed to connect MetaMask:', error);
      showStatus('Failed to connect MetaMask. Please try again.', 'error', 'payment-status');
    }
  } else {
    showStatus('MetaMask not detected. Please install MetaMask.', 'error', 'payment-status');
    window.open('https://metamask.io/download/', '_blank');
  }
};

console.log('‚úÖ MetaMask persistent connection handler loaded');
</script>
// REAL Stripe integration for MountainShares (Stack Overflow solution)
const stripe = Stripe('pk_test_YOUR_REAL_STRIPE_PUBLISHABLE_KEY_HERE');

async function initiatePurchase() {
  const quantity = parseInt(document.getElementById('ms-quantity').value);
  const walletAddress = document.getElementById('wallet-address').value;
  
  if (!quantity || quantity < 1) {
    showStatus('Please enter a valid quantity (minimum 1 MountainShare)', 'error', 'payment-status');
    return;
  }
  
  if (!walletAddress || !walletAddress.startsWith('0x')) {
    showStatus('Please enter a valid Ethereum wallet address or connect MetaMask', 'error', 'payment-status');
    return;
  }
  
  try {
    document.getElementById('purchase-btn').textContent = 'Creating Real Stripe Session...';
    document.getElementById('purchase-btn').disabled = true;
    
    // Create REAL Stripe checkout session (Stack Overflow #68630229 solution)
    const { error } = await stripe.redirectToCheckout({
      lineItems: [{
        price_data: {
          currency: 'usd',
          product_data: {
            name: 'MountainShares Token',
            description: `${quantity} MountainShares for ${walletAddress}`,
          },
          unit_amount: Math.round((quantity * 1.35) * 100), // $1.35 per MS in cents
        },
        quantity: 1,
      }],
      mode: 'payment',
      successUrl: 'https://relaxed-medovik-06c531.netlify.app/success?session_id={CHECKOUT_SESSION_ID}',
      cancelUrl: 'https://relaxed-medovik-06c531.netlify.app/',
      customerEmail: 'customer@example.com',
      metadata: {
        walletAddress: walletAddress,
        quantity: quantity,
        tokenValue: quantity * 1.00,
        totalPaid: quantity * 1.35
      }
    });
    
    if (error) {
      console.error('Stripe error:', error);
      showStatus('Payment failed: ' + error.message, 'error', 'payment-status');
    }
    
  } catch (error) {
    console.error('‚ùå Purchase failed:', error);
    showStatus('Payment session creation failed. Please try again.', 'error', 'payment-status');
  } finally {
    document.getElementById('purchase-btn').textContent = 'Purchase MountainShares';
    document.getElementById('purchase-btn').disabled = false;
  }
}
// Add this to your Commons website (Stack Overflow #68630229 solution)
window.handlePurchaseClick = async function() {
  const quantity = parseInt(document.getElementById('ms-quantity').value) || 1;
  const walletAddress = document.getElementById('wallet-address').value || window.selectedAccount;
  
  try {
    const response = await fetch('https://mountainshares-backend-production.up.railway.app/api/create-checkout-session', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        quantity: quantity,
        walletAddress: walletAddress,
        amount: quantity,
        productName: 'MountainShares Token'
      })
    });
    
    const data = await response.json();
    
    if (data.url) {
      console.log('‚úÖ Session URL received:', data.url);
      // CLIENT-SIDE REDIRECT (Stack Overflow #68630229 solution)
      window.location.href = data.url;
    } else {
      console.log('‚ùå No URL in response');
    }
    
  } catch (error) {
    console.error('‚ùå Purchase failed:', error);
  }
};
/* Force fresh deploy Sat Jun 21 20:12:03 EDT 2025 */

function showTab(tabName) {
    console.log('Switching to tab:', tabName);
    // Add your tab switching logic here
}

